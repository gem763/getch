{% extends "getchapp/layout.html" %}

{% block css %}
  {{ block.super }}
  <style>
    :root {
      --tagger-imgsize: 40px;
    }

    input[type='checkbox'] {
      display: none;
      visibility: hidden;
    }

    #cursor {
      position: absolute;
      background: white;
      top: 50%;
      left: 50%;
      width: 10px;
      height: 10px;
      border-radius: 10px;
      transform: translate(-50%, -50%) scale(0);
      visibility: collapse;
      transition: all 0.1s ease;
      transform-origin: center center;
    }

    #tagger {
      z-index: 100;
      position: absolute;
      background: none;
      top: 0;
      left: 10%;
      right: 10%;
      transform: scale(0);
      /* transform: translateY(-60px), scale(0); */
      visibility: collapse;
      transition: all 0.1s ease;
    }

    #tagger .main.table {
      background: white;
      width: 100%;
      margin: 0;
      border-radius: 0;
      border: 1px solid black;
    }

    #tagger .main.table tr {
      height: var(--tagger-imgsize);
    }

    #tagger .main.table td {
      padding: 0;
    }

    #tagger .main.table td#tagger-brand,
    #tagger .main.table td#tagger-item {
      width: 0;
      transition: all 0.1s ease;
    }

    #tagger .main.table td#plus {
      width: var(--tagger-imgsize);
    }

    #tagger .main.table td#finder {
      position: relative;
    }

    #tagger .main.table td#tagger-brand img {
      object-fit: contain;
      width: 0;
      height: var(--tagger-imgsize);
      background: none;
      display: block;
      transition: all 0.1s ease;
    }

    #tagger .main.table td#tagger-item img {
      width: 0;
      height: 25px;
      background: none;
      display: block;
      vertical-align: middle;
      margin-left: auto;
      margin-right: auto;
    }

    #tagger .main.table td#plus img {
      width: 25px;
      height: 25px;
      background: none;
      display: block;
      vertical-align: middle;
      margin-left: auto;
      margin-right: auto;
    }

    #tagger .main.table .prompt {
      font-size: 15px;
      height: 100%;
      width: 100%;
      border: none;
      background: none;
      border-radius: 0;
    }

    #tagger .main.table .select-item-placeholder {
      position:absolute;
      top:10px;
      left:0;
      background:none;
      visibility:hidden;
      color:gray;
    }

    #item-selector {
      z-index: -1;
      background: white;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      margin: 0;
      border-radius: 0;
      border: 1px solid black;
      transition: all 0.1s ease;
    }

    #item-selector td {
      padding: 0;
      height: 40px;
      border: none;
    }

    #item-selector td img {
      width: 25px;
      height: 25px;
      background: none;
      display: block;
      vertical-align: middle;
      margin-left: auto;
      margin-right: auto;
    }


    #cursor-shower:checked ~ #cursor {
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    #tagger-shower:checked ~ #tagger {
      visibility: visible;
      transform: scale(1);
      /* transform: translateY(-60px) scale(1); */
    }

    #tagger-brand-shower:checked ~ #tagger #tagger-brand {
      width: var(--tagger-imgsize);
      border-right: 1px solid black;
    }

    #tagger-brand-shower:checked ~ #tagger #tagger-brand img {
      width: var(--tagger-imgsize);
    }

    #tagger-brand-shower:checked ~ #tagger #item-selector {
      top: var(--tagger-imgsize);
    }

    #tagger-brand-shower:checked ~ #tagger input.prompt {
      /* display: none; */
      visibility: hidden;
    }

    #tagger-brand-shower:checked ~ #tagger .select-item-placeholder {
      visibility: visible;
    }

    #tagger-item-shower:checked ~ #tagger #tagger-item {
      width: var(--tagger-imgsize);
      border-right: 1px solid black;
    }

    #tagger-item-shower:checked ~ #tagger #tagger-item img {
      width: 25px;
    }

    #tagger-item-shower:checked ~ #tagger #item-selector {
      top: 0;
    }

    #tagger-item-shower:checked ~ #tagger #plus {
      display: none;
    }

    #tagger-item-shower:checked ~ #tagger .select-item-placeholder {
      visibility: hidden;
    }

    .results {
      margin-top: 0 !important;
      border-radius: 0 !important;
      border-top: 0px solid transparent !important;
      border-left: 1px solid black !important;
      border-right: 1px solid black !important;
      border-bottom: 1px solid black !important;
      box-shadow: none !important;
    }

    .result {
      padding: 10px !important;
      border-radius: 0 !important;
      background: none !important;
      border-bottom: 1px solid black !important;
    }

    .result:hover {}
  </style>
{% endblock css %}


{% block mastbody %}
{% load static %}
<div class="ui vertical center aligned segment" style="background:none;border:none;padding:0;">
  <div style="background:red;position:relative;">
    <img id="canvas" src="{{post.image.url}}" style="width:100%;height:auto;display:block;" />

    <input id='cursor-shower' type="checkbox">
    <div id='cursor'></div>

    <input id="tagger-shower" type="checkbox">
    <input id="tagger-brand-shower" type="checkbox">
    <input id="tagger-item-shower" type="checkbox">
    <div id='tagger'>
      <div class="ui fluid search">
        <div class="ui fluid transparent input">

          <table class='main ui unstackable very compact basic table'>
            <tbody>
              <tr>
                <td id='tagger-brand'>
                  <img/>
                </td>

                <td id='tagger-item'>
                  <img/>
                </td>

                <td id='plus'>
                  <img src="/static/materials/icons8-plus-100.png" />
                </td>

                <td id='finder'>
                  <input class="prompt" type="text" placeholder="BRAND" oninput="">
                  <div class='select-item-placeholder'>ITEM</div>
                </td>

                <td id='tagger-undo' style='width:30px;text-align:center;'>
                  <i class='ui undo icon'></i>
                </td>

                <td style='width:30px;text-align:center;'>
                  <i class='ui arrow right icon'></i>
                </td>
              </tr>
            </tbody>
          </table>


          <table id='item-selector' class='ui eight column unstackable very compact basic celled table'>
            <tbody>
              <tr>
                <td><img src="https://storage.googleapis.com/getch-storage/item_images/accessory.png" /></td>
                <td><img src="https://storage.googleapis.com/getch-storage/item_images/bag.png" /></td>
                <td><img src="https://storage.googleapis.com/getch-storage/item_images/bottom.png" /></td>
                <td><img src="https://storage.googleapis.com/getch-storage/item_images/dress.png" /></td>
                <td><img src="https://storage.googleapis.com/getch-storage/item_images/outer.png" /></td>
                <td><img src="https://storage.googleapis.com/getch-storage/item_images/shoe.png" /></td>
                <td><img src="https://storage.googleapis.com/getch-storage/item_images/skirt.png" /></td>
                <td><img src="https://storage.googleapis.com/getch-storage/item_images/top.png" /></td>
              </tr>
            </tbody>
          </table>


        </div>

        <div class="results"></div>
      </div>
    </div>

    <div id='tags'></div>
  </div>
</div>


{% include "getchapp/post-author.html" %}
{% include "getchapp/post-comment.html" %}
{% include "getchapp/post-comment.html" %}
{% endblock mastbody %}

{% block js %}
  {{ block.super }}
  <script>
    var pos;

    $('#canvas').on({
      'click': function(e) {
        pos = get_position(e);

        $('#cursor').css({ left: pos.x_in_canvas + '%', top: pos.y_in_canvas + '%' });
        $('#cursor-shower').prop('checked', true);

        // $('#tagger').css({ top: pos.y_in_canvas + '%' });
        $('#tagger').css({ top: 'calc(' + pos.y_in_canvas + '% - 60px)' });
        $('#tagger-shower').prop('checked', true);

        // 요게 안먹히네..
        // $('#tagger input.prompt').focus();
      },
    });

    function get_position(e) {
      var canvas_position = $(e.target).offset();
      var canvas_left = canvas_position.left;
      var canvas_top = canvas_position.top;
      var canvas_width = $(e.target).width();
      var canvas_height = $(e.target).height();

      var x = e.pageX;
      var y = e.pageY;

      var x_in_canvas = (x - canvas_left) / canvas_width * 100;
      var y_in_canvas = (y - canvas_top) / canvas_height * 100;

      var pos = {
        x: x,
        y: y,
        x_in_canvas: x_in_canvas,
        y_in_canvas: y_in_canvas
      };

      return pos;
    }


    // const template_channeltag = ({ch, image, top, left}) => `
    //   <div class="tag" style="top:${top};left:${left};position:absolute;transform:translate(-50%,-150%);width:40px;height:40px;background:white;border:1px solid black;">
    //     <div class="tag-brand" style="opacity:1;" ch="${ch}">
    //       <a href="{% url 'brand' 1 %}">
    //         <img class="ui image" src="${image}" style="object-fit:contain;width:36px;height:36px;">
    //       </a>
    //     </div>
    //   </div>
    // `;

    function set_brand(ch, image) {
      $('#tagger-brand img').attr('src', 'https://storage.googleapis.com/getch-storage/' + image);
      $('#tagger-brand-shower').prop('checked', true);
    }


    $('#item-selector td').click(function() {
      var src = $(this).children('img').attr('src');
      $('#tagger-item img').attr('src', src);
      $('#tagger-item-shower').prop('checked', true);
    });

    $('#tagger-undo').click(function() {
      if ($('#tagger-item-shower').prop('checked')) {
        $('#tagger-item-shower').prop('checked', false);

      } else if ($('#tagger-brand-shower').prop('checked')) {
        $('#tagger-brand-shower').prop('checked', false);

      } else {
        $('#tagger-shower').prop('checked', false);
      };
    });


    $('#tagger .ui.search').search({
      source: {{ brands | safe }},
      fullTextSearch: true,
      showNoResults: false,
      maxResults: 5,
      minCharacters: 1,
      searchFields: ['name', 'category', 'keywords'],
      templates: {
        standard: function(response){
          htmls = $.map(response.results, function(item) {
                    var image = item.image.replace('\\', '/');
                    var onclick = "set_brand(" + item.pk + ", '" + image + "')";
                    // var onclick = "set_tag(" + item.pk + ", '/files/" + image + "')";
                    var html = '<div class="result" style="height:80px" onclick="' + onclick + '">';
                    html += '<div class="image" style="height:60px;width:60px;border-radius:0;">'
                          // + '<img src="/files/' + item.image + '" style="object-fit:contain;height:80px;width:80px;">'
                          + '<img src="https://storage.googleapis.com/getch-storage/' + item.image + '" style="object-fit:contain;height:60px;width:60px;">'
                          + '</div>';
                    html += '<div class="content">';
                    html += '<div class="ui header">' + item.fullname_en;
                    html += '<div class="sub header">' + item.fullname_kr + '</div>';
                    html += '</div></div>';
                    html += '</div>';
                    return html
                  });

          return htmls
        },
      },
    });
  </script>
{% endblock js %}
