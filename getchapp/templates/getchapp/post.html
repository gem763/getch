{% extends "getchapp/layout.html" %}

{% block css %}
  {{ block.super }}
  <style>
    :root {
      --tagger-imgsize: 40px;
    }

    input[type='checkbox'] {
      display: none;
      visibility: hidden;
    }

    #cursor {
      position: absolute;
      background: white;
      top: 50%;
      left: 50%;
      width: 10px;
      height: 10px;
      border-radius: 10px;
      transform: translate(-50%, -50%) scale(0);
      visibility: collapse;
      transition: all 0.1s ease;
      transform-origin: center center;
    }

    #tagger {
      z-index: 100;
      position: absolute;
      background: none;
      top: 0;
      left: 10%;
      right: 10%;
      transform: scale(0);
      visibility: collapse;
      transition: all 0.1s ease;
    }

    #tagbox {
      background: white;
      width: 100%;
      margin: 0;
      border-radius: 0;
      border: 1px solid black;
    }


    #tagger td {
      padding: 0;
      height: var(--tagger-imgsize);
      transition: all 0.1s ease;
      position: relative;
    }

    #tagger td.iconbutton {
      width: var(--tagger-imgsize);
    }

    #tagger td#profiletag {
      width: var(--tagger-imgsize);
      border-right: 1px solid black;
    }

    #tagger td img {
      object-fit: contain;
      background: none;
      display: block;
      vertical-align: middle;
      margin-left: auto;
      margin-right: auto;
      width: var(--tagger-imgsize);
      height: var(--tagger-imgsize);
      transition: all 0.1s ease;
    }

    #tagger td.iconbutton img {
      width: 25px;
      height: 25px;
    }

    #tagger td#brandtag img {
      width: 0;
    }

    #tagger td#itemtag img {
      width: 0;
      height: 25px;
    }

    #tagger td#rating img {
      width: 25px;
      height: 25px;
      display: inline-block;
      opacity: 0.3;
    }


    #tagbox .prompt {
      font-size: 15px;
      height: 100%;
      width: 100%;
      border: none;
      background: none;
      border-radius: 0;
    }

    #tagbox .select-item-placeholder {
      position: absolute;
      top: 10px;
      left: 0;
      background: none;
      visibility: hidden;
      color: gray;
    }

    #itemselector,
    #editor {
      z-index: -1;
      background: white;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      margin: 0;
      border-radius: 0;
      border: 1px solid black;
      transition: all 0.1s ease;
      visibility: hidden;
    }

    #editor > table {
      border: none;
      width: 100%;
      margin: 0;
      border-bottom: 1px solid black;
      border-radius: 0;
    }



    #cursor-control:checked ~ #cursor {
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    #tagger-control:checked ~ #tagger {
      visibility: visible;
      transform: scale(1);
    }


    #brandtag-control:checked ~ #tagger #brandtag {
      width: var(--tagger-imgsize);
      border-right: 1px solid black;
    }

    #brandtag-control:checked ~ #tagger #brandtag img {
      width: var(--tagger-imgsize);
    }

    #brandtag-control:checked ~ #tagger #itemselector {
      visibility: visible;
      top: var(--tagger-imgsize);
    }

    #brandtag-control:checked ~ #tagger input.prompt {
      visibility: hidden;
    }

    #brandtag-control:checked ~ #tagger .select-item-placeholder {
      visibility: visible;
    }


    #itemtag-control:checked ~ #tagger #itemtag {
      width: var(--tagger-imgsize);
      border-right: 1px solid black;
    }

    #itemtag-control:checked ~ #tagger #itemtag img {
      width: 25px;
    }

    #itemtag-control:checked ~ #tagger #itemselector {
      visibility: hidden;
      top: 0;
    }

    #itemtag-control:checked ~ #tagger #plus {
      display: none;
    }

    #itemtag-control:checked ~ #tagger .select-item-placeholder {
      visibility: hidden;
    }

    #itemtag-control:checked ~ #tagger #editor {
      visibility: visible !important;
      top: 40px !important;
    }

    /* #tagger-save:checked ~ #tagger #editor {
      visibility: hidden !important;
      top: 0 !important;
    }

    #tagger-save:checked ~ #tagger #undo {
      display: none;
    }

    #tagger-save:checked ~ #tagger #finder {
      display: none;
    }

    #tagger-save:checked ~ #tagbox {
      width: 83px;
    }

    #tagger-save:checked ~ #tagger #itemtag {
      border-right: 0;
    } */

    #editor #tagtext {
      padding: 10px;
    }

    #editor #tagtext textarea {
      resize: none;
      background: none;
      width: 100%;
      height: 40px;
      overflow-y: hidden;
      border: none;
      line-height: 1.3em;
      margin: 0;
      display: block;
    }

    #editor #footbuttons {
      background: none;
      padding: 5px;
    }

    #editor #footbuttons .button {
      width: 45%;
      border-radius: 0;
      margin: 5px;
    }

    .results {
      margin-top: 0 !important;
      border-radius: 0 !important;
      border-top: 0px solid transparent !important;
      border-left: 1px solid black !important;
      border-right: 1px solid black !important;
      border-bottom: 1px solid black !important;
      box-shadow: none !important;
    }

    .result {
      padding: 10px !important;
      border-radius: 0 !important;
      background: none !important;
      border-bottom: 1px solid black !important;
      height: 80px !important;
    }

    .result > .image {
      height: 60px !important;
      width: 60px !important;
      border-radius: 0 !important;
    }

    .result > .image > img {
      object-fit: contain !important;
      height: 60px !important;
      width: 60px !important;
    }

    .result:hover {}
  </style>
{% endblock css %}


{% block mastbody %}
{% load static %}
<div class="ui vertical center aligned segment" style="background:none;border:none;padding:0;">
  <div style="background:red;position:relative;">
    <img id="canvas" src="{{post.image.url}}" style="width:100%;height:auto;display:block;" />

    <input id='cursor-control' type="checkbox">
    <div id='cursor'></div>

    <input id="tagger-control" type="checkbox">
    <input id="brandtag-control" type="checkbox">
    <input id="itemtag-control" type="checkbox">
    <!-- <input id="tagger-save" type="checkbox"> -->

    <div id='tagger'>
      <div class="ui fluid search">
        <div class="ui fluid transparent input">

          <table id='tagbox' class='main ui unstackable very compact basic table'>
            <tbody>
              <tr>
                <td id='brandtag'>
                  <img/>
                </td>

                <td id='itemtag'>
                  <img/>
                </td>

                <td id='plus' class='iconbutton'>
                  <img src="/static/materials/icons8-plus-100.png" />
                </td>

                <td id='finder'>
                  <input class="prompt" type="text" placeholder="BRAND" oninput="">
                  <div class='select-item-placeholder'>ITEM</div>
                </td>

                <td id='undo' class='iconbutton'>
                  <img src="/static/materials/icons8-left-96.png" />
                </td>
              </tr>
            </tbody>
          </table>


          <table id='itemselector' class='tagger--bar ui eight column unstackable very compact basic table'>
            <tbody>
              <tr>
                {% for item in items %}
                <td class='iconbutton'><img src='https://storage.googleapis.com/getch-storage/{{item.image}}' /></td>
                {% endfor %}
              </tr>
            </tbody>
          </table>


          <div id='editor'>
            <table class='ui unstackable very compact basic table'>
              <tbody>
                <tr>
                  <td id='profiletag'>
                    {% include "getchapp/avatar.html" %}
                  </td>

                  <td id='rating'>
                    <img src="/static/materials/icons8-star-96.png">
                    <img src="/static/materials/icons8-star-96.png">
                    <img src="/static/materials/icons8-star-96.png">
                    <img src="/static/materials/icons8-star-96.png">
                    <img src="/static/materials/icons8-star-96.png">
                  </td>

                  <td class='iconbutton'>
                    <img src="/static/materials/icons8-unsplash-96.png">
                  </td>
                </tr>
              </tbody>
            </table>

            <div id='tagtext'>
              <textarea placeholder='COMMENT HERE'></textarea>
            </div>

            <div id='footbuttons'>
              <div class="cancel ui basic black mini button">CANCEL</div>
              <div class="save ui black mini button">SAVE</div>
            </div>
          </div>

        </div>

        <div class="results"></div>
      </div>
    </div>

    <div id='tags'></div>
  </div>
</div>


{% include "getchapp/post-author.html" %}
{% include "getchapp/post-comment.html" %}
{% include "getchapp/post-comment.html" %}
{% endblock mastbody %}

{% block js %}
  {{ block.super }}
  <script>
    var pos;

    $('#canvas').on({
      'click': function(e) {
        pos = get_position(e);

        $('#cursor').css({ left: pos.x_in_canvas + '%', top: pos.y_in_canvas + '%' });
        $('#cursor-control').prop('checked', true);

        $('#tagger').css({ top: 'calc(' + pos.y_in_canvas + '% - 60px)' });
        $('#tagger-control').prop('checked', true);

        // 요게 안먹히네..
        // $('#tagger input.prompt').focus();
      },
    });

    function get_position(e) {
      var canvas_position = $(e.target).offset();
      var canvas_left = canvas_position.left;
      var canvas_top = canvas_position.top;
      var canvas_width = $(e.target).width();
      var canvas_height = $(e.target).height();

      var x = e.pageX;
      var y = e.pageY;

      var x_in_canvas = (x - canvas_left) / canvas_width * 100;
      var y_in_canvas = (y - canvas_top) / canvas_height * 100;

      var pos = {
        x: x,
        y: y,
        x_in_canvas: x_in_canvas,
        y_in_canvas: y_in_canvas
      };

      return pos;
    }


    function set_brand(ch, image) {
      $('#brandtag img').attr('src', image);
      $('#brandtag-control').prop('checked', true);
    }


    $('#itemselector td').click(function() {
      var src = $(this).children('img').attr('src');
      $('#itemtag img').attr('src', src);
      $('#itemtag-control').prop('checked', true);
    });

    $('#undo').click(function() {
      if ($('#itemtag-control').prop('checked')) {
        $('#itemtag-control').prop('checked', false);

      } else if ($('#brandtag-control').prop('checked')) {
        $('#brandtag-control').prop('checked', false);

      } else {
        $('#tagger-control').prop('checked', false);
      };
    });


    $('#tagger .ui.search').search({
      source: {{ brands | safe }},
      fullTextSearch: true,
      showNoResults: false,
      maxResults: 5,
      minCharacters: 1,
      searchFields: ['name', 'category', 'keywords'],
      templates: {
        standard: function(response){
          htmls = $.map(response.results, function(item) {
                    var image = 'https://storage.googleapis.com/getch-storage/' + item.image.replace('\\', '/');
                    var onclick = "set_brand(" + item.pk + ", '" + image + "')";
                    var html = '<div class="result" onclick="' + onclick + '">';
                    html += '<div class="image">'
                          + '<img src="' + image + '">'
                          + '</div>';
                    html += '<div class="content">';
                    html += '<div class="ui header">' + item.fullname_en;
                    html += '<div class="sub header">' + item.fullname_kr + '</div>';
                    html += '</div></div>';
                    html += '</div>';
                    return html
                  });

          return htmls
        },
      },
    });


    $('#editor textarea').on({
      'focusin': function() {
        this.style.height = '40px';
        this.style.height = (this.scrollHeight) + 'px';
      },

      'focusout': function() {
        if (this.value=='') {
          this.style.height = '40px';
        };
      },

      'input': function() {
        this.style.height = '40px';
        this.style.height = (this.scrollHeight) + 'px';
      }
    });



    const template_tag = (tag_id) => `
      <div class='tag' style='position:absolute;;left:${pos.x_in_canvas}%;top:${pos.y_in_canvas}%;'>
        1234;
      </div>
    `


    $('#save').click(function() {
      // $('#tagger-save').prop('checked', true);
      // $('#tagger').css({ left: 'calc(' + pos.x_in_canvas + '% - 40px)' });

      let tag = template_tag(0);
      $('#tags').append($(tag));
    });
  </script>
{% endblock js %}
